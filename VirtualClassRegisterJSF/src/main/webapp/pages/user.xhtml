<ui:composition
  template="/templates/page-template.xhtml"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:ui="jakarta.faces.facelets"
  xmlns:h="jakarta.faces.html"
  xmlns:f="jakarta.faces.core"
  xmlns:p="http://primefaces.org/ui"
>
  <ui:define name="title">Virtual Class Register - User</ui:define>

  <ui:define name="content">
    <p:panel
      header="Add User"
      styleClass="mb-4"
      toggleable="true"
      collapsed="true"
    >
      <h:form id="form">
        <p:panelGrid columns="2" layout="grid">
          <p:outputLabel for="forename">Forename</p:outputLabel>
          <p:inputText
            id="forename"
            value="#{userBB.user.forename}"
            required="true"
            requiredMessage="Forename is required!"
            maxlength="65"
            validatorMessage="Forename has to be between 2 to 65 characters!"
          >
            <f:validateLength minimum="2" maximum="65" />
          </p:inputText>

          <p:outputLabel for="surname">Surname</p:outputLabel>
          <p:inputText
            id="surname"
            value="#{userBB.user.surname}"
            required="true"
            requiredMessage="Surname is required!"
            maxlength="85"
            validatorMessage="Surname has to be between 2 to 85 characters!"
          >
            <f:validateLength minimum="2" maximum="85" />
          </p:inputText>

          <p:outputLabel for="email">Email</p:outputLabel>
          <p:inputText
            id="email"
            value="#{userBB.user.email}"
            required="true"
            requiredMessage="Email is required!"
            maxlength="120"
            validatorMessage="Invalid email format!"
          >
            <f:validateRegex
              pattern="^[_A-Za-z0-9-\+]+(\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9]+)*(\.[A-Za-z]{2,})$"
            />
            <f:validateLength maximum="120" />
          </p:inputText>
          
          <p:outputLabel for="role">Role</p:outputLabel>
          <p:selectOneMenu
            id="role"
            value="#{userBB.user.role}"
            required="true"
            requiredMessage="Role is required!"
          >
            <f:selectItem itemLabel="Select Role" itemValue="" />
            <f:selectItem itemLabel="Student" itemValue="Student" />
            <f:selectItem itemLabel="Teacher" itemValue="Nauczyciel" />
            <f:selectItem itemLabel="Administrator" itemValue="Administrator" />
            <p:ajax update="class" />
          </p:selectOneMenu>

          <p:outputLabel for="class">Class</p:outputLabel>
          <p:selectOneMenu id="class" value="#{userBB.user.clazz.idClass}">
            <f:selectItem itemLabel="Select Class" itemValue="" />
            <f:selectItems
              value="#{userBB.classes}"
              var="c"
              itemLabel="#{c.name}"
              itemValue="#{c.idClass}"
            />
          </p:selectOneMenu>

          <h:panelGroup>
            <p:outputLabel for="password">Password</p:outputLabel>
            <p class="text-sm m-0">
              Minimum eight characters, at least one uppercase letter, one
              lowercase letter and one number
            </p>
          </h:panelGroup>
          <p:password
            id="password"
            value="#{userBB.user.password}"
            match="repeatPassword"
            required="true"
            requiredMessage="Password is required!"
            validatorMessage="Invalid password format!"
          >
            <f:validateRegex pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$" />
          </p:password>

          <p:outputLabel for="repeatPassword">Repeat Password</p:outputLabel>
          <p:password
            id="repeatPassword"
            value="#{userBB.user.password}"
            required="true"
            requiredMessage="Repeat Password is required!"
          />
        </p:panelGrid>

        <p:commandButton
          styleClass="m-1"
          value="Add User"
          action="#{userBB.addUser()}"
          update="@form users-panel"
        />
      </h:form>
    </p:panel>

    <p:messages id="messages" closable="true">
      <p:autoUpdate />
    </p:messages>

    <p:panel id="users-panel">
      <h:form>
        <p:panelGrid columns="2" layout="grid">
          <p:outputLabel for="email">Email</p:outputLabel>
          <p:inputText
            id="email"
            value="#{userBB.searchEmail}"
            maxlength="120"
          />
        </p:panelGrid>

        <p:commandButton
          styleClass="m-1"
          value="Search"
          action="#{userBB.search()}"
          update="@form"
        />
        <p:commandButton
          styleClass="m-1"
          value="Clear"
          action="#{userBB.clear()}"
          update="@form"
        />

        <p:commandButton value="CSV" styleClass="m-1">
          <p:dataExporter type="csv" target="users" fileName="users" />
        </p:commandButton>

        <p:linkButton
          styleClass="m-1"
          outcome="administrationPanel"
          value="Go back"
        />

        <p:dataTable
          id="users"
          value="#{userBB.lazyUser}"
          var="u"
          paginator="true"
          rows="10"
          rowsPerPageTemplate="5,10,15"
        >
          <p:column>
            <f:facet name="header">
              <h:outputText value="Name" />
            </f:facet>
            <h:outputText value="#{u.name}" />
          </p:column>

          <p:column>
            <f:facet name="header">
              <h:outputText value="Email" />
            </f:facet>
            <h:outputText value="#{u.email}" />
          </p:column>

          <p:column>
            <f:facet name="header">
              <h:outputText value="Role" />
            </f:facet>
            <h:outputText value="#{u.role}" />
          </p:column>

          <p:column exportable="false">
            <f:facet name="header">
              <h:outputText value="Options" />
            </f:facet>
            <p:commandButton
              styleClass="m-1"
              value="Details"
              ajax="false"
              action="#{userBB.editUser(u)}"
            />
            <p:commandButton
              styleClass="m-1"
              value="Remove"
              action="#{userBB.removeUser(u)}"
              update="@form"
            />
          </p:column>
        </p:dataTable>
      </h:form>
    </p:panel>
  </ui:define>
</ui:composition>
